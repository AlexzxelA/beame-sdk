#!/usr/bin/env ngs

# NGS language - https://github.com/ilyash/ngs/

if 'BEAME_DIR' in ENV {
	throw Error("BEAME_DIR environment variable must be unset for tests")
}

HOME = ENV.HOME

BEAME_DIR = HOME / '.beame'
BEAME_BIN = HOME / 'beame-sdk/src/cli/beame.js'

{ ENV.SNI_SERVER_PORT = '0' }

if Path(BEAME_DIR) {
	throw Error("Beame directory exists ($BEAME_DIR). Will not run tests.")
}

{ type TestFail(Error) }

F do_test(name:Str, f:Fun) {
	echo("")
	echo("=== TEST: $name ===")
	result = try {
		msg = f()
		"OK: $msg"
	} catch(tf:TestFail) {
		# TODO: .info should be .message when fixed in NGS
		global exit_code = max([exit_code, 1])
		"FAIL: ${tf.info}"
	} catch(e) {
		global exit_code = max([exit_code, 2])
		"FAIL: $e"
	}
	echo("  RESULT: $result")
}

do_test


echo("All tests done. Exit code: $exit_code")
{ exit_code }
