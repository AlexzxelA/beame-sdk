#!/usr/bin/env ngs

BEAME_BIN = '../../src/cli/beame.js'
entity_name_pfx = "sdk-test-${time()}-${pid()}"

F create_entity_under_fqdn(fqdn, idx) {
	entity = ``$BEAME_BIN creds getCreds --name "${entity_name_pfx}-${idx}" --email "${entity_name_pfx}-${idx}@example.com" --fqdn $fqdn --format json``
	entity.assert_hash_keys(%[parent_fqdn approved_by_fqdn level email name], "Entity hash keys")
	echo("New entity: $entity")
	entity.fqdn
}

fqdn = ARGV[0]
levels = Int(ARGV[1])

for(i;levels) {
	test("Iteration [${i+1}/$levels] [fqdn $fqdn]") with {
		global fqdn
		fqdn = create_entity_under_fqdn(fqdn, i)
	}
}
